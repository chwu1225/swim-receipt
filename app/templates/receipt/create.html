{% extends "base.html" %}

{% block title %}é–‹ç«‹æ”¶æ“š{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <div class="card">
        <h2 class="card-title">ğŸ“ é–‹ç«‹æ”¶æ“š</h2>

        <form method="POST" id="receiptForm">
            <div class="form-group">
                <label for="item_id">æ”¶è²»é …ç›® *</label>
                <select id="item_id" name="item_id" class="form-control" required>
                    <option value="">-- è«‹é¸æ“‡æ”¶è²»é …ç›® --</option>
                    {% set current_category = namespace(value='') %}
                    {% for item in fee_items %}
                        {% if item.category != current_category.value %}
                            {% if current_category.value %}
                            </optgroup>
                            {% endif %}
                            <optgroup label="{{ item.category or 'å…¶ä»–' }}">
                            {% set current_category.value = item.category %}
                        {% endif %}
                        <option value="{{ item.id }}" data-price="{{ item.default_price }}">
                            {{ item.item_name }} - ${{ item.default_price|int }}
                        </option>
                    {% endfor %}
                    {% if current_category.value %}
                    </optgroup>
                    {% endif %}
                </select>
            </div>

            <div class="form-group">
                <label for="amount">é‡‘é¡ *</label>
                <input type="number" id="amount" name="amount" class="form-control"
                       required min="1" step="1" placeholder="è«‹è¼¸å…¥é‡‘é¡">
            </div>

            <div class="form-group">
                <label for="remark">å‚™è¨»</label>
                <input type="text" id="remark" name="remark" class="form-control"
                       placeholder="é¸å¡«ï¼Œå¦‚æœ‰éœ€è¦å¯å¡«å¯«å‚™è¨»">
            </div>

            <div id="preview" class="card" style="background-color: #f8f9fa; display: none;">
                <h4 style="margin-bottom: 0.5rem;">ğŸ“‹ æ”¶æ“šé è¦½</h4>
                <p><strong>æ”¶è²»é …ç›®ï¼š</strong><span id="preview-item"></span></p>
                <p><strong>é‡‘é¡ï¼š</strong>$<span id="preview-amount"></span> å…ƒ</p>
                <p><strong>ç¶“è¾¦å“¡ï¼š</strong>{{ current_user.full_name }}</p>
            </div>

            <div class="d-flex gap-1 mt-2">
                <button type="submit" class="btn btn-success">ç¢ºèªé–‹ç«‹</button>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">å–æ¶ˆ</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.getElementById('item_id');
    const amountInput = document.getElementById('amount');
    const preview = document.getElementById('preview');
    const previewItem = document.getElementById('preview-item');
    const previewAmount = document.getElementById('preview-amount');

    itemSelect.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        if (selected.value) {
            const price = selected.dataset.price;
            amountInput.value = price;
            updatePreview();
        }
    });

    amountInput.addEventListener('input', updatePreview);

    function updatePreview() {
        const selectedOption = itemSelect.options[itemSelect.selectedIndex];
        if (selectedOption.value && amountInput.value) {
            previewItem.textContent = selectedOption.text.split(' - ')[0];
            previewAmount.textContent = parseInt(amountInput.value).toLocaleString();
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    document.getElementById('receiptForm').addEventListener('submit', function(e) {
        if (!itemSelect.value) {
            e.preventDefault();
            alert('è«‹é¸æ“‡æ”¶è²»é …ç›®');
            return;
        }
        if (!amountInput.value || amountInput.value <= 0) {
            e.preventDefault();
            alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
            return;
        }
        if (!confirm('ç¢ºå®šè¦é–‹ç«‹æ­¤æ”¶æ“šå—ï¼Ÿ')) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
